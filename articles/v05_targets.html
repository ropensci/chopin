<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>targets and grid objects • chopin</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="targets and grid objects">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">chopin</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.8.0.20240903</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/v01_start.html">Getting started with chopin</a></li>
    <li><a class="dropdown-item" href="../articles/v02_good_practice.html">Good practice of using `chopin` in HPC</a></li>
    <li><a class="dropdown-item" href="../articles/v03_par_pad_grid.html">Generate computational grids</a></li>
    <li><a class="dropdown-item" href="../articles/v04_climate_examples.html">Extracting Weather/Climate Geospatial Data with `chopin`</a></li>
    <li><a class="dropdown-item" href="../articles/v05_targets.html">targets and grid objects</a></li>
  </ul>
</li>
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/NIEHS/chopin/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>targets and grid objects</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/NIEHS/chopin/blob/main/vignettes/v05_targets.Rmd" class="external-link"><code>vignettes/v05_targets.Rmd</code></a></small>
      <div class="d-none name"><code>v05_targets.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="objective">Objective<a class="anchor" aria-label="anchor" href="#objective"></a>
</h2>
<p><code>targets</code> is a powerful workflow management for
reproducibility. <code>chopin</code> grid partitioning is a way to
parallelize the repeated tasks across unit grids by applying patterns.
This vignette demonstrates how to use <code>targets</code> and
<code>chopin</code> together.</p>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>Despite the <code>targets</code> is not referenced in the
<code>DESCRIPTION</code> file, it is required to install
<code>targets</code> package to run the code in this vignette.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/is_installed.html" class="external-link">check_installed</a></span><span class="op">(</span><span class="st">"targets"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h2>
<p><code><a href="../reference/par_pad_grid.html">par_pad_grid()</a></code> or <code><a href="../reference/par_pad_balanced.html">par_pad_balanced()</a></code>
functions have an argument <code>return_wkt</code> to return the grid
partition as well-known text (WKT) format characters. This format is
exported to the parallel workers regardless of the parallel backend such
as <code><a href="https://future.futureverse.org/reference/multisession.html" class="external-link">future::multisession</a></code> and <code><a href="https://shikokuchuo.net/mirai/reference/daemons.html" class="external-link">mirai::daemons</a></code>,
which cannot interoperate with <code>externalpnt</code> objects for C++
functions. Using WKT character objects, we can easily convert them to
<code>sf</code> or <code>terra</code> objects <strong>inside</strong> a
function running on a parallel worker and use them in the
<code>targets</code> workflow with standard branching/patterning
interface such as <code>map()</code>, <code>cross()</code>, and
others.</p>
<p>The example below will generate a grid partition of the North
Carolina state and demonstrate how to use the grid partition in the
<code>targets</code> workflow.</p>
<div class="section level3">
<h3 id="random-points-in-nc">Random points in NC<a class="anchor" aria-label="anchor" href="#random-points-in-nc"></a>
</h3>
<ul>
<li>For demonstration of <code><a href="../reference/par_pad_grid.html">par_pad_grid()</a></code>, we use moderately
clustered point locations generated inside the counties of North
Carolina.</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/NIEHS/chopin" class="external-link">chopin</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://spatstat.org/" class="external-link">spatstat.random</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/s2.html" class="external-link">sf_use_s2</a></span><span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">202404</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ncpoly</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"shape/nc.shp"</span>, package <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span></span>
<span><span class="va">ncsf</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="va">ncpoly</span><span class="op">)</span></span>
<span><span class="va">ncsf</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">ncsf</span>, <span class="st">"EPSG:5070"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">ncsf</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="v05_targets_files/figure-html/nc-gen-points-1.png" width="700"></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ncpoints</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_sample.html" class="external-link">st_sample</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">ncsf</span>,</span>
<span>    type <span class="op">=</span> <span class="st">"Thomas"</span>,</span>
<span>    mu <span class="op">=</span> <span class="fl">20</span>,</span>
<span>    scale <span class="op">=</span> <span class="fl">1e4</span>,</span>
<span>    kappa <span class="op">=</span> <span class="fl">1.25e-9</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">ncpoints</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">ncpoints</span><span class="op">)</span></span>
<span><span class="va">ncpoints</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_set_crs</a></span><span class="op">(</span><span class="va">ncpoints</span>, <span class="st">"EPSG:5070"</span><span class="op">)</span></span>
<span><span class="va">ncpoints</span><span class="op">$</span><span class="va">pid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"PID-%05d"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">ncpoints</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">ncpoints</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="v05_targets_files/figure-html/nc-gen-points-2.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="grid-partition-of-nc">Grid partition of NC<a class="anchor" aria-label="anchor" href="#grid-partition-of-nc"></a>
</h3>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ncgrid_sf</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/par_pad_grid.html">par_pad_grid</a></span><span class="op">(</span></span>
<span>    input <span class="op">=</span> <span class="va">ncpoints</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"grid"</span>,</span>
<span>    nx <span class="op">=</span> <span class="fl">6L</span>,</span>
<span>    ny <span class="op">=</span> <span class="fl">3L</span>,</span>
<span>    padding <span class="op">=</span> <span class="fl">1e4L</span>,</span>
<span>    return_wkt <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">ncgrid_sf</span><span class="op">$</span><span class="va">original</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 18 features and 1 field</span></span>
<span><span class="co">## Geometry type: POLYGON</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 1057207 ymin: 1355826 xmax: 1830521 ymax: 1676488</span></span>
<span><span class="co">## Projected CRS: NAD83 / Conus Albers</span></span>
<span><span class="co">## First 10 features:</span></span>
<span><span class="co">##                          geometry CGRIDID</span></span>
<span><span class="co">## 1  POLYGON ((1057207 1355826, ...       1</span></span>
<span><span class="co">## 2  POLYGON ((1186092 1355826, ...       2</span></span>
<span><span class="co">## 3  POLYGON ((1314978 1355826, ...       3</span></span>
<span><span class="co">## 4  POLYGON ((1443864 1355826, ...       4</span></span>
<span><span class="co">## 5  POLYGON ((1572750 1355826, ...       5</span></span>
<span><span class="co">## 6  POLYGON ((1701635 1355826, ...       6</span></span>
<span><span class="co">## 7  POLYGON ((1057207 1462714, ...       7</span></span>
<span><span class="co">## 8  POLYGON ((1186092 1462714, ...       8</span></span>
<span><span class="co">## 9  POLYGON ((1314978 1462714, ...       9</span></span>
<span><span class="co">## 10 POLYGON ((1443864 1462714, ...      10</span></span></code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ncgrid_sf</span><span class="op">$</span><span class="va">padded</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 18 features and 1 field</span></span>
<span><span class="co">## Geometry type: POLYGON</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 1047207 ymin: 1345826 xmax: 1840521 ymax: 1686488</span></span>
<span><span class="co">## Projected CRS: NAD83 / Conus Albers</span></span>
<span><span class="co">## First 10 features:</span></span>
<span><span class="co">##    CGRIDID                       geometry</span></span>
<span><span class="co">## 1        1 POLYGON ((1047207 1345826, ...</span></span>
<span><span class="co">## 2        2 POLYGON ((1176092 1345826, ...</span></span>
<span><span class="co">## 3        3 POLYGON ((1304978 1345826, ...</span></span>
<span><span class="co">## 4        4 POLYGON ((1433864 1345826, ...</span></span>
<span><span class="co">## 5        5 POLYGON ((1562750 1345826, ...</span></span>
<span><span class="co">## 6        6 POLYGON ((1691635 1345826, ...</span></span>
<span><span class="co">## 7        7 POLYGON ((1047207 1452714, ...</span></span>
<span><span class="co">## 8        8 POLYGON ((1176092 1452714, ...</span></span>
<span><span class="co">## 9        9 POLYGON ((1304978 1452714, ...</span></span>
<span><span class="co">## 10      10 POLYGON ((1433864 1452714, ...</span></span></code></pre>
<p>Since <code>sf</code> objects are exportable to the parallel workers,
we can also consider these as a part of the <code>targets</code>
workflow.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ncgrid_wkt</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/par_pad_grid.html">par_pad_grid</a></span><span class="op">(</span></span>
<span>    input <span class="op">=</span> <span class="va">ncpoints</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"grid"</span>,</span>
<span>    nx <span class="op">=</span> <span class="fl">6L</span>,</span>
<span>    ny <span class="op">=</span> <span class="fl">3L</span>,</span>
<span>    padding <span class="op">=</span> <span class="fl">1e4L</span>,</span>
<span>    return_wkt <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">ncgrid_wkt</span><span class="op">$</span><span class="va">original</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "POLYGON ((1057207 1355826, 1186092 1355826, 1186092 1462714, 1057207 1462714, 1057207 1355826))"</span></span>
<span><span class="co">##  [2] "POLYGON ((1186092 1355826, 1314978 1355826, 1314978 1462714, 1186092 1462714, 1186092 1355826))"</span></span>
<span><span class="co">##  [3] "POLYGON ((1314978 1355826, 1443864 1355826, 1443864 1462714, 1314978 1462714, 1314978 1355826))"</span></span>
<span><span class="co">##  [4] "POLYGON ((1443864 1355826, 1572750 1355826, 1572750 1462714, 1443864 1462714, 1443864 1355826))"</span></span>
<span><span class="co">##  [5] "POLYGON ((1572750 1355826, 1701635 1355826, 1701635 1462714, 1572750 1462714, 1572750 1355826))"</span></span>
<span><span class="co">##  [6] "POLYGON ((1701635 1355826, 1830521 1355826, 1830521 1462714, 1701635 1462714, 1701635 1355826))"</span></span>
<span><span class="co">##  [7] "POLYGON ((1057207 1462714, 1186092 1462714, 1186092 1569601, 1057207 1569601, 1057207 1462714))"</span></span>
<span><span class="co">##  [8] "POLYGON ((1186092 1462714, 1314978 1462714, 1314978 1569601, 1186092 1569601, 1186092 1462714))"</span></span>
<span><span class="co">##  [9] "POLYGON ((1314978 1462714, 1443864 1462714, 1443864 1569601, 1314978 1569601, 1314978 1462714))"</span></span>
<span><span class="co">## [10] "POLYGON ((1443864 1462714, 1572750 1462714, 1572750 1569601, 1443864 1569601, 1443864 1462714))"</span></span>
<span><span class="co">## [11] "POLYGON ((1572750 1462714, 1701635 1462714, 1701635 1569601, 1572750 1569601, 1572750 1462714))"</span></span>
<span><span class="co">## [12] "POLYGON ((1701635 1462714, 1830521 1462714, 1830521 1569601, 1701635 1569601, 1701635 1462714))"</span></span>
<span><span class="co">## [13] "POLYGON ((1057207 1569601, 1186092 1569601, 1186092 1676488, 1057207 1676488, 1057207 1569601))"</span></span>
<span><span class="co">## [14] "POLYGON ((1186092 1569601, 1314978 1569601, 1314978 1676488, 1186092 1676488, 1186092 1569601))"</span></span>
<span><span class="co">## [15] "POLYGON ((1314978 1569601, 1443864 1569601, 1443864 1676488, 1314978 1676488, 1314978 1569601))"</span></span>
<span><span class="co">## [16] "POLYGON ((1443864 1569601, 1572750 1569601, 1572750 1676488, 1443864 1676488, 1443864 1569601))"</span></span>
<span><span class="co">## [17] "POLYGON ((1572750 1569601, 1701635 1569601, 1701635 1676488, 1572750 1676488, 1572750 1569601))"</span></span>
<span><span class="co">## [18] "POLYGON ((1701635 1569601, 1830521 1569601, 1830521 1676488, 1701635 1676488, 1701635 1569601))"</span></span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ncgrid_wkt</span><span class="op">$</span><span class="va">padded</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "POLYGON ((1047207 1345826, 1047207 1472714, 1196092 1472714, 1196092 1345826, 1047207 1345826))"</span></span>
<span><span class="co">##  [2] "POLYGON ((1176092 1345826, 1176092 1472714, 1324978 1472714, 1324978 1345826, 1176092 1345826))"</span></span>
<span><span class="co">##  [3] "POLYGON ((1304978 1345826, 1304978 1472714, 1453864 1472714, 1453864 1345826, 1304978 1345826))"</span></span>
<span><span class="co">##  [4] "POLYGON ((1433864 1345826, 1433864 1472714, 1582750 1472714, 1582750 1345826, 1433864 1345826))"</span></span>
<span><span class="co">##  [5] "POLYGON ((1562750 1345826, 1562750 1472714, 1711635 1472714, 1711635 1345826, 1562750 1345826))"</span></span>
<span><span class="co">##  [6] "POLYGON ((1691635 1345826, 1691635 1472714, 1840521 1472714, 1840521 1345826, 1691635 1345826))"</span></span>
<span><span class="co">##  [7] "POLYGON ((1047207 1452714, 1047207 1579601, 1196092 1579601, 1196092 1452714, 1047207 1452714))"</span></span>
<span><span class="co">##  [8] "POLYGON ((1176092 1452714, 1176092 1579601, 1324978 1579601, 1324978 1452714, 1176092 1452714))"</span></span>
<span><span class="co">##  [9] "POLYGON ((1304978 1452714, 1304978 1579601, 1453864 1579601, 1453864 1452714, 1304978 1452714))"</span></span>
<span><span class="co">## [10] "POLYGON ((1433864 1452714, 1433864 1579601, 1582750 1579601, 1582750 1452714, 1433864 1452714))"</span></span>
<span><span class="co">## [11] "POLYGON ((1562750 1452714, 1562750 1579601, 1711635 1579601, 1711635 1452714, 1562750 1452714))"</span></span>
<span><span class="co">## [12] "POLYGON ((1691635 1452714, 1691635 1579601, 1840521 1579601, 1840521 1452714, 1691635 1452714))"</span></span>
<span><span class="co">## [13] "POLYGON ((1047207 1559601, 1047207 1686488, 1196092 1686488, 1196092 1559601, 1047207 1559601))"</span></span>
<span><span class="co">## [14] "POLYGON ((1176092 1559601, 1176092 1686488, 1324978 1686488, 1324978 1559601, 1176092 1559601))"</span></span>
<span><span class="co">## [15] "POLYGON ((1304978 1559601, 1304978 1686488, 1453864 1686488, 1453864 1559601, 1304978 1559601))"</span></span>
<span><span class="co">## [16] "POLYGON ((1433864 1559601, 1433864 1686488, 1582750 1686488, 1582750 1559601, 1433864 1559601))"</span></span>
<span><span class="co">## [17] "POLYGON ((1562750 1559601, 1562750 1686488, 1711635 1686488, 1711635 1559601, 1562750 1559601))"</span></span>
<span><span class="co">## [18] "POLYGON ((1691635 1559601, 1691635 1686488, 1840521 1686488, 1840521 1559601, 1691635 1559601))"</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="targets-workflow">Targets workflow<a class="anchor" aria-label="anchor" href="#targets-workflow"></a>
</h3>
<p>Assume that we design a function <code>calc_something()</code> that
calculates something from the grid partition. We can use the grid
partition as an input to the function. In <code>sf</code> object
centered workflow, we can use <code>sf</code> functions to interact with
the exported grid partition objects. Let’s consider a binary spatial
operation where <code>x</code> and <code>y</code> are involved.
<code>x</code> is a dataset at the variable is calculated whereas
<code>y</code> is a raster file path from which we extract the values.
Please note that SpatRaster objects cannot be exported to parallel
workers as it is. We will read the object in parallel workers. To branch
out across the grid partition, the function for the unit grid should
handle subsetting <code>x</code> to narrow down the calculation scope to
each grid. Therefore, a synopsis of the function should look like
this:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">calc_something</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">unit_grid</span>, <span class="va">pad_grid</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># 0. restore unit_grid and pad_grid to sf objects if they are in WKT format</span></span>
<span>  <span class="co"># 1-1. make x subset using intersect logic between x and unit_grid</span></span>
<span>  <span class="co"># 1-2. read y subset using intersect logic between y and pad_grid</span></span>
<span>  <span class="co"># 2. make buffer of x</span></span>
<span>  <span class="co"># 3. do actual calculation (use ... wisely to pass additional arguments)</span></span>
<span>  <span class="co"># 4. return the result</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><code>map(unit_grid, pad_grid)</code> to <code>pattern</code>
argument <code>tar_target()</code> will do it for you.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">calc_something</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">unit_grid</span>, <span class="va">pad_grid</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># 1-1. make x subset using intersect logic between x and unit_grid</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="va">unit_grid</span>, <span class="op">]</span></span>
<span>  <span class="co"># 1-2. read y subset using intersect logic between y and pad_grid</span></span>
<span>  <span class="va">yext</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="va">pad_grid</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">yras</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">y</span>, win <span class="op">=</span> <span class="va">yext</span><span class="op">)</span></span>
<span>  <span class="co"># 2. make buffer of x</span></span>
<span>  <span class="va">xbuffer</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_buffer</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html" class="external-link">set_units</a></span><span class="op">(</span><span class="fl">10</span>, <span class="st">"km"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># 3. do actual calculation (use ... wisely to pass additional arguments)</span></span>
<span>  <span class="va">xycalc</span> <span class="op">&lt;-</span> <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html" class="external-link">exact_extract</a></span><span class="op">(</span></span>
<span>    <span class="va">yras</span>,</span>
<span>    <span class="va">xbuffer</span>,</span>
<span>    force_df <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    fun <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>    append_cols <span class="op">=</span> <span class="st">"pid"</span>, <span class="co"># assume that pid is a unique identifier</span></span>
<span>    progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="co"># 4. return the result</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">xycalc</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><code>sf</code> object inherits <code>data.frame</code> class. To
align this object with <code>targets</code> branching, it will be clear
to convert this object into a <code>list</code> object to pattern across
the grid partition. <code>par_split_list</code> in chopin does it for
you.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ncgrid_sflist</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/par_split_list.html">par_split_list</a></span><span class="op">(</span><span class="va">ncgrid_sf</span><span class="op">)</span></span></code></pre></div>
<p>When WKT format is used, the function should be modified to restore
the grid partition to <code>sf</code> objects. The function should be
modified as follows:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">calc_something</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">unit_grid</span>, <span class="va">pad_grid</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># 0. restore unit_grid and pad_grid to sf objects if they are in WKT format</span></span>
<span>  <span class="va">unit_grid</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span>wkt <span class="op">=</span> <span class="va">unit_grid</span><span class="op">)</span></span>
<span>  <span class="va">pad_grid</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span>wkt <span class="op">=</span> <span class="va">pad_grid</span><span class="op">)</span></span>
<span>  <span class="co"># 1-1. make x subset using intersect logic between x and unit_grid</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="va">unit_grid</span>, <span class="op">]</span></span>
<span>  <span class="co"># 1-2. read y subset using intersect logic between y and pad_grid</span></span>
<span>  <span class="va">yext</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="va">pad_grid</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">yras</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">y</span>, win <span class="op">=</span> <span class="va">yext</span><span class="op">)</span></span>
<span>  <span class="co"># 2. make buffer of x</span></span>
<span>  <span class="va">xbuffer</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_buffer</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html" class="external-link">set_units</a></span><span class="op">(</span><span class="fl">10</span>, <span class="st">"km"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># 3. do actual calculation (use ... wisely to pass additional arguments)</span></span>
<span>  <span class="va">xycalc</span> <span class="op">&lt;-</span> <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html" class="external-link">exact_extract</a></span><span class="op">(</span></span>
<span>    <span class="va">yras</span>,</span>
<span>    <span class="va">xbuffer</span>,</span>
<span>    fun <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>    force_df <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    append_cols <span class="op">=</span> <span class="st">"pid"</span>, <span class="co"># assume that pid is a unique identifier</span></span>
<span>    progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="co"># 4. return the result</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">xycalc</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ncgrid_wktlist</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/par_split_list.html">par_split_list</a></span><span class="op">(</span><span class="va">ncgrid_wkt</span><span class="op">)</span></span></code></pre></div>
<p><code>tar_target</code> can use this list object with our function
<code>calc_something</code> to branch out. A workable example of
<code>tar_target</code> with a proper _targets.R file is as follows:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu">tar_target</span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="va">points</span>,</span>
<span>    command <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="st">"path_to_points.format"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu">tar_target</span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="va">raster</span>,</span>
<span>    command <span class="op">=</span> <span class="st">"path_to_raster.format"</span>,</span>
<span>    format <span class="op">=</span> <span class="st">"file"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu">tar_target</span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="va">chopingrid</span>,</span>
<span>    command <span class="op">=</span> <span class="fu"><a href="../reference/par_pad_grid.html">par_pad_grid</a></span><span class="op">(</span><span class="va">points</span>, input <span class="op">=</span> <span class="va">points</span>, nx <span class="op">=</span> <span class="fl">6L</span>, ny <span class="op">=</span> <span class="fl">3L</span>, padding <span class="op">=</span> <span class="fl">1e4L</span>, return_wkt <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu">tar_target</span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="va">chopingrid_split</span>,</span>
<span>    command <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mapply.html" class="external-link">mapply</a></span><span class="op">(</span></span>
<span>      <span class="kw">function</span><span class="op">(</span><span class="va">listorig</span>, <span class="va">row</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">listorig</span><span class="op">$</span><span class="va">original</span><span class="op">[</span><span class="va">row</span>, <span class="op">]</span>, <span class="va">listorig</span><span class="op">$</span><span class="va">padded</span><span class="op">[</span><span class="va">row</span>, <span class="op">]</span><span class="op">)</span></span>
<span>      <span class="op">}</span>,</span>
<span>      <span class="va">chopingrid</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">chopingrid</span><span class="op">$</span><span class="va">original</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      SIMPLIFY <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span>,</span>
<span>    iteration <span class="op">=</span> <span class="st">"list"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu">tar_target</span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="va">result</span>,</span>
<span>    command <span class="op">=</span></span>
<span>    <span class="fu">calc_something</span><span class="op">(</span></span>
<span>      <span class="va">points</span>, <span class="va">raster</span>,</span>
<span>      <span class="va">chopingrid_split</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">chopingrid_split</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="op">)</span>,</span>
<span>    pattern <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">chopingrid_split</span><span class="op">)</span>,</span>
<span>    iteration <span class="op">=</span> <span class="st">"list"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The target <code>result</code> will be a list of
<code>data.frame</code>s that contain the calculation results.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Insang Song, Kyle Messier.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
